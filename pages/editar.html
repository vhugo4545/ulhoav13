<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proposta com Inputs e Tabela</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="../css/listagem.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

</head>

<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <ul>
    
      <li><a href="../pages/listagem.html"><span class="material-icons-outlined">list</span> Início</a></li>
     
    </ul>
<div class="sidebar-footer">
  <button id="btn-criar" class="sidebar-button" onclick="salvarPropostaEditavel()">
    <span class="material-icons-outlined">add_circle_outline</span><br> Duplicar Proposta
  </button>

  <button id="btn-editar-modelo" class="sidebar-button" onclick="redirecionarParaEdicao()">
    <span class="material-icons-outlined">edit_note</span><br>  Editar Modelo
  </button>

 <a id="btn-editar-formulas" href="modelo.html" class="sidebar-button" style="text-decoration: none; flex-direction: column;">
  <span class="material-icons-outlined">functions</span>
  Editar Fórmulas
</a>


  <button id="btn-atualizar" class="sidebar-button" onclick="atualizarPropostaEditavel()">
    <span class="material-icons-outlined">edit</span><br>  Atualizar (Salvar)
  </button>

  <button id="btn-solicitar" class="sidebar-button" onclick="marcarPendenteAprovacao()">
    <span class="material-icons-outlined">assignment_turned_in</span><br> Solicitar Aprovação
  </button>

  <button id="btn-autorizar" class="sidebar-button" onclick="marcarPrecosDivergentesOmie()">
    <span class="material-icons-outlined">verified_user</span><br>  Autorizar Proposta
  </button>

  <button id="btn-enviar-cliente" class="sidebar-button" onclick="marcarEnviadoParaCliente()">
    <span class="material-icons-outlined">send</span><br>  Enviar Proposta
  </button>

  <button id="btn-aprovado-cliente" class="sidebar-button" onclick="marcarAprovadoPeloCliente()">
    <span class="material-icons-outlined">check_circle</span><br>  Aprovado pelo Cliente
  </button>

  <button id="btn-gerar-pedido" class="sidebar-button" onclick="atualizarNaOmie()">
    <span class="material-icons-outlined">receipt_long</span><br> Gerar Pedido de Venda
  </button>

  <button id="btn-atualizar-precos" class="sidebar-button" onclick="atualizarPrecosOmieNaDOM()">
    <span class="material-icons-outlined">sync</span><br>  Atualizar Preços da Omie
  </button>
</div>

<script>
  function redirecionarParaEdicao() {
    const id = new URLSearchParams(location.search).get("id");
    window.location.href = "editar.html?id=" + id;
  }
</script>


  </aside>



  <!-- CONTEÚDO PRINCIPAL -->
  <main class="content">
    <div class="main-container">
      <form id="novoOrcamentoForm">
        <div class="accordion mb-3" id="accordionOrcamento">

          <!-- Aba: Informações do Orçamento -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseInfoOrcamento">
                Informações do Orçamento
              </button>
            </h2>
            <div id="collapseInfoOrcamento" class="accordion-collapse collapse show">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Número do Orçamento</label>
                    <input type="text" class="form-control" id="numeroOrcamento" readonly tabindex="-1"
                      style="background-color: #e6e6e6; color: #000;">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Data do Orçamento</label>
                    <input type="date" class="form-control" id="dataOrcamento" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Origem do Cliente</label>
                    <select class="form-select" id="origemCliente" required>
                      <option value="">Selecione</option>
                      <option>Arquiteto(a)</option>
                      <option>Construtora</option>
                      <option>Engenheiro(a)</option>
                      <option>Google</option>
                      <option>Instagram</option>
                      <option>Indicação</option>
                      <option>Já é cliente</option>
                      <option>Licitação</option>
                      <option>Outros</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Aba: Dados do Cliente -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseCliente">
                Dados do Cliente
              </button>
            </h2>
            <div id="collapseCliente" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div id="clientesWrapper">
                  <div class="row g-3 cliente-item">
                    <div class="col-md-6 position-relative d-flex align-items-end gap-2">
                      <div class="flex-grow-1">
                        <label class="form-label">Nome / Razão Social</label>
                        <input type="text" class="form-control razaoSocial" placeholder="Digite para buscar..."
                          autocomplete="off">
                        <ul class="sugestoesCliente list-group position-absolute w-100 shadow bg-white"
                          style="z-index: 10; max-height: 200px; overflow-y: auto; display: none;"></ul>
                      </div>
                      <button type="button" class="btn btn-outline-success rounded-circle" title="Incluir Cliente"
                        onclick="abrirPopupIncluirCliente()"
                        style="height: 38px; width: 38px; display: flex; align-items: center; justify-content: center;">
                        <strong>+</strong>
                      </button>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Código Omie</label>
                      <input type="text" class="form-control codigoCliente" readonly
                        style="background-color: #dfdfe0; color: #000;">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CPF / CNPJ</label>
                      <input type="text" class="form-control cpfCnpj" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Nome do Contato</label>
                      <input type="text" class="form-control nomeContato">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Função</label>
                      <input type="text" class="form-control funcaoCliente">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Telefone</label>
                      <input type="text" class="form-control telefoneCliente">
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary mt-2"
                  onclick="adicionarClienteRelacionado()">Adicionar Cliente Relacionado</button>
              </div>
            </div>
          </div>

          <!-- Aba: Endereço da Obra -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseEndereco">
                Endereço da Obra
              </button>
            </h2>
            <div id="collapseEndereco" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-3"><label class="form-label">CEP</label><input type="text" class="form-control"
                      id="cep"></div>
                  <div class="col-md-6"><label class="form-label">Rua / Avenida</label><input type="text"
                      class="form-control" id="rua"></div>
                  <div class="col-md-3"><label class="form-label">Número</label><input type="text" class="form-control"
                      id="numero"></div>
                  <div class="col-md-4"><label class="form-label">Complemento</label><input type="text"
                      class="form-control" id="complemento"></div>
                  <div class="col-md-4"><label class="form-label">Bairro</label><input type="text" class="form-control"
                      id="bairro"></div>
                  <div class="col-md-2"><label class="form-label">Cidade</label><input type="text" class="form-control"
                      id="cidade"></div>
                  <div class="col-md-2"><label class="form-label">Estado</label><input type="text" class="form-control"
                      id="estado"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Aba: Equipe Interna -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseEquipe">
                Equipe Interna
              </button>
            </h2>
            <div id="collapseEquipe" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Vendedor Responsável</label>
                    <select class="form-select" id="vendedorResponsavel" required>
                      <option value="">Carregando...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Operador (Usuário Interno)</label>
                    <input type="text" class="form-control" id="operadorInterno">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Aba: Produtos, Condições e Prazos -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseProdutos">
                Produtos, Prazos e Condições
              </button>
            </h2>
            <div id="collapseProdutos" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="mb-3">
                  <label class="form-label">Prazos por Área</label>
                  <textarea class="form-control" id="prazosArea" rows="2"
                    placeholder="Área ___: ___ dias úteis após aprovação..."></textarea>
                </div>

                <div class="mb-3">
                  <label class="form-label">Condição de Pagamento</label>
                  <select class="form-select" id="condicaoPagamento">
                    <option value="">Selecione</option>
                    <option value="debito">40% de entrada, 40% após 30 dias e 20% após 60 dias.</option>
                    <option value="debito">40% de entrada, 30% após 30 dias e 30% após 60 dias.</option>
                    <option value="debito">60% de entrada, 40% após 30 dias.</option>
                    <option value="parcelado">Personalizado</option>
                  </select>
                </div>

                <div id="parcelamentoContainer" style="display: none;">
                  <label class="form-label">Parcelas</label>
                  <div id="listaParcelas"></div>
                  <strong>Total das parcelas: <span id="totalParcelas">R$ 0,00</span></strong>
                  <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="adicionarParcela()">+ Adicionar
                    Parcela</button>
                </div>

                <div class="mb-3 mt-3">
                  <label class="form-label">Condições Gerais</label>
                  <div class="d-flex flex-wrap gap-2 mb-2">
                    <button type="button" class="btn btn-outline-primary"
                      onclick="preencherCondicoesComInstalacao()">Com medição e instalação</button>
                    <button type="button" class="btn btn-outline-secondary"
                      onclick="preencherCondicoesSemInstalacao()">Sem medição e instalação</button>
                    <button type="button" class="btn btn-outline-warning" onclick="preencherCondicoesSemTampo()">Sem
                      tampo</button>
                  </div>
                  <textarea class="form-control" id="condicoesGerais" rows="10"
                    placeholder="Escolha uma opção ou edite manualmente..."></textarea>
                </div>

              </div>
            </div>
          </div>


        </div>
      </form>


      <div class="col-lg-12" id="blocosProdutosContainer">
        <!-- Blocos dinâmicos de produtos serão adicionados aqui -->
      </div>
    </div>
    <br>
    <br>
    <br>
    <br>
    <div id="loader-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background-color:rgba(255,255,255,0.7); justify-content:center; align-items:center;">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
    </div>


  </main>

  <div class="modal fade" id="popupClienteModal" tabindex="-1" aria-labelledby="popupClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="popupClienteLabel">Incluir Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="popupCliente_form">
            <div class="mb-3 d-none">
              <label class="form-label">Código de Integração</label>
              <input type="text" class="form-control" id="popupCliente_codigo" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Razão Social</label>
              <input type="text" class="form-control" id="popupCliente_razao" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Nome Fantasia</label>
              <input type="text" class="form-control" id="popupCliente_fantasia" required>
            </div>
            <div class="mb-3">
              <label class="form-label">E-mail</label>
              <input type="email" class="form-control" id="popupCliente_email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">CNPJ ou CPF</label>
              <input type="text" class="form-control" id="popupCliente_cnpjcpf" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Estado</label>
              <select class="form-select" id="popupCliente_estado" required>
                <option value="" disabled selected>Selecione o estado</option>
                <option value="AC">Acre (AC)</option>
                <option value="AL">Alagoas (AL)</option>
                <option value="AP">Amapá (AP)</option>
                <option value="AM">Amazonas (AM)</option>
                <option value="BA">Bahia (BA)</option>
                <option value="CE">Ceará (CE)</option>
                <option value="DF">Distrito Federal (DF)</option>
                <option value="ES">Espírito Santo (ES)</option>
                <option value="GO">Goiás (GO)</option>
                <option value="MA">Maranhão (MA)</option>
                <option value="MT">Mato Grosso (MT)</option>
                <option value="MS">Mato Grosso do Sul (MS)</option>
                <option value="MG">Minas Gerais (MG)</option>
                <option value="PA">Pará (PA)</option>
                <option value="PB">Paraíba (PB)</option>
                <option value="PR">Paraná (PR)</option>
                <option value="PE">Pernambuco (PE)</option>
                <option value="PI">Piauí (PI)</option>
                <option value="RJ">Rio de Janeiro (RJ)</option>
                <option value="RN">Rio Grande do Norte (RN)</option>
                <option value="RS">Rio Grande do Sul (RS)</option>
                <option value="RO">Rondônia (RO)</option>
                <option value="RR">Roraima (RR)</option>
                <option value="SC">Santa Catarina (SC)</option>
                <option value="SP">São Paulo (SP)</option>
                <option value="SE">Sergipe (SE)</option>
                <option value="TO">Tocantins (TO)</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" onclick="enviarClienteParaAPI()">Salvar Cliente</button>
        </div>
      </div>
    </div>
  </div>

  <div id="overlayPopup"
    style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:9998;">
  </div>

  <!-- Popup centralizado -->
  <div id="popupPendencias"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.3); z-index:9999; max-width:400px;">
    <h5 class="mb-3">⚠️ Pendências Encontradas</h5>
    <ul id="listaPendencias" class="mb-3" style="padding-left: 18px;"></ul>
    <button onclick="fecharPopupPendencias()" class="btn btn-secondary w-100">Fechar</button>
  </div>
  <script src="../js/validarToken.js" defer></script>
  <script src="../js/sair.js" defer></script>
  <!-- SCRIPTS -->
  <script src="../js/validarToken.js" defer></script>
  <script src="../js/auth.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="../js/preencher.js" defer></script>

  <script src="../js/formularioOrcamento.js" defer></script>
  <script src="../js/tabelas.js" defer></script>
  <script src="../js/produtos.js" defer></script>
  <!-- Scripts principais (em ordem lógica e sem duplicatas) -->
  <script src="../js/clienteAutocomplete.js" defer></script>
  <script src="../js/consultaCEP.js" defer></script>

  <script src="../js/BarraPesquisa.js" defer></script>


  <script src="../js/equipeInterna.js" defer></script>
  <script src="../js/prazosCondicoes.js" defer></script>

  <script src="../js/formulas.js" defer></script>

  <script src="../js/imprimir.js" defer></script>
  <script src="../js/enviarPropostas.js" defer></script>
  <script src="../js/carregamento.js" defer></script>
  <script src="../js/formularioOrcamento.js" defer></script>
  <script src="../js/formulaValores.js" defer></script>
  <script src="../js/salvarPropostas.js" defer></script>
  <script src="../js/carregamento.js" defer></script>
  <script src="../js/visualizarBotoes.js" defer></script>
  <script src="../js/envioOmie.js" defer></script>
  <script src="../js/totais.js" defer></script>
  <script>
    function fecharTodasSanfonas() {
      document.querySelectorAll(".accordion-button").forEach(botao => {
        if (!botao.classList.contains("collapsed")) {
          botao.click();
        }
      });
    }
    function abrirTodasSanfonas() {
      document.querySelectorAll(".accordion-button").forEach(botao => {
        if (botao.classList.contains("collapsed")) {
          botao.click();
        }
      });
    }



  </script>
  <script>
    // Gera um código de integração aleatório (interno)
    function gerarCodigoClienteIntegracao() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let codigo = "";
      for (let i = 0; i < 7; i++) {
        codigo += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return codigo;
    }

    // Aplica máscara dinâmica para CPF ou CNPJ
    function aplicarMascaraCnpjCpf(valor) {
      valor = valor.replace(/\D/g, "");
      if (valor.length <= 11) {
        return valor.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, "$1.$2.$3-$4");
      } else {
        return valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{1,2})/, "$1.$2.$3/$4-$5");
      }
    }

    // Abre o popup e limpa os campos
    function abrirPopupIncluirCliente() {
      const form = document.getElementById("popupCliente_form");
      const modalEl = document.getElementById("popupClienteModal");

      if (!form || !modalEl) {
        console.warn("⚠️ Popup ou formulário não encontrado.");
        return;
      }

      form.reset();
      new bootstrap.Modal(modalEl).show();
    }

    // Função para remover caracteres não numéricos
    function limparNumero(valor) {
      return valor.replace(/\D/g, "");
    }

    function abrirTodasSanfonas() {
      document.querySelectorAll(".accordion-button").forEach(botao => {
        if (botao.classList.contains("collapsed")) {
          botao.click();
        }
      });
    }
    // Validação de CPF
    function validarCPF(cpf) {
      cpf = limparNumero(cpf);
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

      let soma = 0;
      for (let i = 0; i < 9; i++) soma += +cpf[i] * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== +cpf[9]) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) soma += +cpf[i] * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;

      return resto === +cpf[10];
    }

    // Validação de CNPJ
    function validarCNPJ(cnpj) {
      cnpj = limparNumero(cnpj);
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;

      let t = cnpj.length - 2,
        d = cnpj.substring(t),
        d1 = 0,
        d2 = 0;

      for (let i = t - 1, j = 5; i >= 0; j = j === 2 ? 9 : j - 1) {
        d1 += +cnpj[i] * j;
      }

      d1 = 11 - (d1 % 11);
      if (d1 >= 10) d1 = 0;
      if (d1 !== +d[0]) return false;

      for (let i = t, j = 6; i >= 0; j = j === 2 ? 9 : j - 1) {
        d2 += +cnpj[i] * j;
      }

      d2 = 11 - (d2 % 11);
      if (d2 >= 10) d2 = 0;

      return d2 === +d[1];
    }

    // Envia cliente para API
    async function enviarClienteParaAPI() {
      const form = document.getElementById("popupCliente_form");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const email = document.getElementById("popupCliente_email").value.trim();
      if (!email.includes("@")) {
        alert("⚠️ Por favor, insira um e-mail válido.");
        return;
      }

      const cnpjCpfRaw = document.getElementById("popupCliente_cnpjcpf").value.trim();
      const cnpjCpf = limparNumero(cnpjCpfRaw);

      const tipoDocumentoValido =
        cnpjCpf.length === 11 ? validarCPF(cnpjCpf) : validarCNPJ(cnpjCpf);

      if (!tipoDocumentoValido) {
        alert("⚠️ CPF ou CNPJ inválido.");
        return;
      }

      mostrarCarregando();

      const cliente = {
        codigo_cliente_integracao: gerarCodigoClienteIntegracao(),
        razao_social: document.getElementById("popupCliente_razao").value.trim(),
        nome_fantasia: document.getElementById("popupCliente_fantasia").value.trim(),
        email,
        cnpj_cpf: cnpjCpf,
        estado: document.getElementById("popupCliente_estado").value.trim(),
      };

      try {
        const resposta = await fetch("https://ulhoa-0a02024d350a.herokuapp.com/clientes/incluirCliente", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cliente),
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
          bootstrap.Modal.getInstance(document.getElementById("popupClienteModal"))?.hide();

          preencherCamposCliente({
            nome_razao_social: cliente.razao_social,
            codigoOmie: resultado?.codigo_cliente_omie || "",
            cpfCnpj: cliente.cnpj_cpf,
            nome_contato: cliente.nome_fantasia,
            funcao: "",
            telefone: ""
          });

          const mensagem = `Cliente ${cliente.razao_social} foi cadastrado com sucesso e está disponível para seleção.`;
          ocultarCarregando();
          mostrarPopupCustomizado("✅ Cliente incluído com sucesso!", mensagem, "success");
          ocultarCarregando();
        } else {
          const erroMensagem = resultado?.message || "Erro inesperado ao incluir cliente.";
          mostrarPopupCustomizado("❌ Erro ao incluir cliente", erroMensagem, "danger");
          ocultarCarregando();
        }
      } catch (err) {
        const erroMensagem = resultado?.message || "Erro inesperado ao incluir cliente.";
        mostrarPopupCustomizado("❌ Erro ao incluir cliente", erroMensagem, "danger");
        ocultarCarregando();
      }
    }
    // Aplica máscara ao digitar
    document.addEventListener("input", function (e) {
      if (e.target.id === "popupCliente_cnpjcpf") {
        e.target.value = aplicarMascaraCnpjCpf(e.target.value);
      }
    });

    // Preenche campos no formulário principal
    function preencherCamposCliente(cliente) {
      const container = document.querySelector(".cliente-item");
      if (!container) return;

      container.querySelector(".razaoSocial").value = cliente.nome_razao_social || "";
      container.querySelector(".codigoCliente").value = cliente.codigoOmie || "";
      container.querySelector(".cpfCnpj").value = cliente.cpfCnpj || "";
      container.querySelector(".nomeContato").value = cliente.nome_contato || "";
      container.querySelector(".funcaoCliente").value = cliente.funcao || "";
      container.querySelector(".telefoneCliente").value = cliente.telefone || "";
    }
  </script>


</body>

</html>